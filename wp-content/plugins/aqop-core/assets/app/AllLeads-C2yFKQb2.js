import{j as e}from"./query-vendor-CG4xf7JE.js";import{r as n}from"./react-vendor-Ch0kAUMy.js";import{u as I,L as $}from"./index-DcCoICHm.js";import{a as Q,b as G}from"./useLeads-BthcpCpB.js";import{g as J}from"./users-COxa5-Qp.js";import{h as K,i as X}from"./leads-CQ_k3CbU.js";import{N as Y}from"./Navigation-B2sBVjrF.js";import{L as Z}from"./LeadCard-Cq47qKLX.js";import"./helpers-Os691a1s.js";function me(){const{user:g}=I(),[i,j]=n.useState({status:"",priority:"",search:"",assigned_to:"",country:"",source:""}),{data:C,isLoading:m,error:h,refetch:S}=Q(i,!1,{refetchInterval:6e4}),r=C?.data?.results||[],L=G(),[b,A]=n.useState([]),[ee,_]=n.useState(!0),[B,F]=n.useState([]),[se,E]=n.useState(!0);g?.roles?.includes("aq_country_manager");const P=["administrator","operation_admin","operation_manager"].includes(g?.role),[o,d]=n.useState([]),[te,T]=n.useState(!1),[c,v]=n.useState(""),[x,y]=n.useState(""),[N,w]=n.useState(!1);n.useEffect(()=>{U(),H()},[]);const U=async()=>{try{const s=await J();A(s||[])}catch(s){console.error("Error fetching agents:",s)}finally{_(!1)}},H=async()=>{try{const s=await K();F(s?.data||[])}catch(s){console.error("Error fetching countries:",s)}finally{E(!1)}},u=(s,l)=>{j(a=>({...a,[s]:l}))},M=()=>{j({status:"",priority:"",search:"",assigned_to:"",country:"",source:""})},R=s=>{d(l=>l.includes(s)?l.filter(a=>a!==s):[...l,s])},D=()=>{o.length===r.length?d([]):d(r.map(s=>s.id))},O=async()=>{if(!(!c||o.length===0)){w(!0);try{const s=[];for(const l of o){const a={};if(c==="assign"&&x)a.assigned_to=parseInt(x);else if(c.startsWith("status_")){const p=c.replace("status_","");a.status_code=p}Object.keys(a).length>0&&s.push(L.mutateAsync({id:l,data:a}))}await Promise.all(s),d([]),v(""),y(""),T(!1),alert(`Successfully updated ${o.length} lead(s)!`)}catch(s){console.error("Bulk action error:",s),alert("Some updates may have failed. Please check and try again.")}finally{w(!1)}}},V=async()=>{try{const s=await X({...i,per_page:9999});if(!s.success||!s.data?.results){alert("Failed to fetch data for export");return}const l=s.data.results,a=["ID","Name","Email","Phone","Country","Status","Priority","Assigned To","Created"],p=l.map(t=>[t.id,t.name,t.email||"",t.phone||"",t.country_name_en||"",t.status_name_en||"",t.priority||"",t.assigned_to_name||"Unassigned",t.created_at||""]),W=[a.join(","),...p.map(t=>t.map(z=>`"${String(z).replace(/"/g,'""')}"`).join(","))].join(`
`),q=new Blob([W],{type:"text/csv"}),k=window.URL.createObjectURL(q),f=document.createElement("a");f.href=k,f.download=`leads-export-${new Date().toISOString().split("T")[0]}.csv`,f.click(),window.URL.revokeObjectURL(k)}catch(s){console.error("Export failed:",s),alert("An error occurred during export.")}};return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsx(Y,{currentPage:"all-leads"}),e.jsx("main",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"All Leads"}),e.jsxs("p",{className:"mt-1 text-gray-600",children:["System-wide lead management - ",e.jsx("span",{className:"font-medium text-indigo-600",children:g?.display_name})]})]}),P&&e.jsxs("button",{onClick:V,disabled:r.length===0,className:"inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 transition-colors",children:[e.jsx("svg",{className:"w-5 h-5 mr-2 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export CSV"]})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"search",className:"block text-sm font-medium text-gray-700 mb-1",children:"Search"}),e.jsx("input",{type:"text",id:"search",value:i.search,onChange:s=>u("search",s.target.value),placeholder:"Search leads...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"country",className:"block text-sm font-medium text-gray-700 mb-1",children:"Country"}),e.jsxs("select",{id:"country",value:i.country,onChange:s=>u("country",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Countries"}),B.map(s=>e.jsx("option",{value:s.id,children:s.country_name_en},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{id:"status",value:i.status,onChange:s=>u("status",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Statuses"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"contacted",children:"Contacted"}),e.jsx("option",{value:"qualified",children:"Qualified"}),e.jsx("option",{value:"converted",children:"Converted"}),e.jsx("option",{value:"lost",children:"Lost"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"priority",className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs("select",{id:"priority",value:i.priority,onChange:s=>u("priority",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Priorities"}),e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"assigned_to",className:"block text-sm font-medium text-gray-700 mb-1",children:"Assigned To"}),e.jsxs("select",{id:"assigned_to",value:i.assigned_to,onChange:s=>u("assigned_to",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Agents"}),e.jsx("option",{value:"unassigned",children:"Unassigned"}),b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:M,className:"w-full px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500",children:"Clear Filters"})})]})}),o.length>0&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm font-medium text-blue-900",children:[o.length," lead",o.length!==1?"s":""," selected"]}),e.jsxs("select",{value:c,onChange:s=>v(s.target.value),className:"px-3 py-1 border border-blue-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Action"}),e.jsx("option",{value:"assign",children:"Assign To..."}),e.jsx("option",{value:"status_pending",children:"Change Status → Pending"}),e.jsx("option",{value:"status_contacted",children:"Change Status → Contacted"}),e.jsx("option",{value:"status_qualified",children:"Change Status → Qualified"}),e.jsx("option",{value:"status_converted",children:"Change Status → Converted"}),e.jsx("option",{value:"status_lost",children:"Change Status → Lost"})]}),c==="assign"&&e.jsxs("select",{value:x,onChange:s=>y(s.target.value),className:"px-3 py-1 border border-blue-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Agent"}),b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("button",{onClick:O,disabled:N||!c||c==="assign"&&!x,className:"px-4 py-1 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50",children:N?"Processing...":"Apply"})]}),e.jsx("button",{onClick:()=>d([]),className:"text-sm text-blue-600 hover:text-blue-800",children:"Clear Selection"})]})}),m&&e.jsx("div",{className:"flex justify-center py-12",children:e.jsx($,{size:"lg",text:"Loading all leads..."})}),h&&!m&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-5 h-5 text-red-600 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("p",{className:"text-red-800",children:h.message||"Failed to load leads"})]})}),!m&&!h&&r.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No leads found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:Object.values(i).some(s=>s)?"Try adjusting your filters":"No leads in the system yet"})]}),!m&&!h&&r.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"checkbox",checked:o.length===r.length,onChange:D,className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",e.jsx("span",{className:"font-medium",children:r.length})," lead",r.length!==1?"s":""]})]}),e.jsxs("button",{onClick:()=>S(),className:"text-sm text-blue-600 hover:text-blue-800 flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Refresh"]})]}),e.jsx("div",{className:"space-y-4",children:r.map(s=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("input",{type:"checkbox",checked:o.includes(s.id),onChange:()=>R(s.id),className:"mt-6 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("div",{className:"flex-1",children:e.jsx(Z,{lead:s,showAssignee:!0})})]},s.id))})]})]})})]})}export{me as default};
